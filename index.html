<!DOCTYPE html>
<html>
<head>
    <title>Sintaxer</title>
    <meta charset="utf8">
<style>
body{font-family: sans-serif;}
#output {display: table; width: 100%}
.rule {display: table-row; font-family: monospace}
.rule:target .name {background: black; color: white;}
.rule .item{display: table-cell}
.rule.edit{background: #ddd;}
.definition::before{content: '::= '; vertical-align: top;}
.name{padding-right: 0.25em; vertical-align: top;}
.name.repetition{color:#aaa}
.def-item{padding-left: 0.25em; text-decoration: none}
.even{background: #eee}
.terminal{color:green}
.production{color:blue}
.semantic{color:red}
.regex{color:darkgoldenrod;}
#output .buttons{width: 5em; background: #eee;vertical-align: top;}
#output .button{width:1em; border: 1px solid black;display:inline-block;cursor: pointer}
.extra-tokens {font-family: monospace;}
.extra-tokens span {display: inline-block; border: 1px solid #ccc;padding-right: 1em; width: 5em;}/*TODO: Some flex thing?*/
.extra-tokens span:nth-child(2n) {background: #eee;}
.extra-tokens span:target {background: black; color: white;}
</style>
<script id="templ-output" type="text/html">
{{#rules}}
    <div class="rule rule-{{ruleName}} {{#even}}even{{/even}} 
{{#newRule}}head{{/newRule}} {{classes}}" id="rule-{{ruleName}}">
        <span class="name item {{^newRule}}repetition{{/newRule}}">
            {{ruleName}}
        </span>
        <span class="definition item">
            {{#ruleDef}}
                {{#link}}
                    <a href="{{link}}" class="def-item {{classes}}">
                        {{item}}
                    </a>
                {{/link}}
                {{^link}}
                    <span class="def-item {{classes}}">
                        {{item}}
                    </span>
                {{/link}}
            {{/ruleDef}}
        </span>
        {{#newRule}}
        <span class="buttons item">{{!
            }}<span class="button jEdit">E</span>{{!
            }}<span class="button jUp">&uparrow;</span>{{!
            }}<span class="button jDown">&downarrow;</span>{{!
            }}<span class="button jDelete">&times;</span>{{!
        }}</span>
        {{/newRule}}
    </div>
{{/rules}}
</script>
<script id="templ-tokens" type="text/html">
<dl>
{{#tokens}}
    <dt>{{name}}</dt>
    <dd>{{value}}</dd>
{{/tokens}}
</dl>
</script>
<script id="templ-edit" type="text/html">
    <span class="definition item">
        <textarea class="value">{{value}}</textarea>
    </span>
    <span class="buttons item">{{!
        }}<span class="button jOkEdit">&radic;</span>{{!
        }}<span class="button jResetEdit">R</span>{{!
    }}</span>
</script>
<script id="default-syntax" type="text/x-syntax">
pgm         ::= {begin-stack} {begin-symboltbl} stms {end-symboltbl} {stack-result} {end-stack} 
stms        ::= stm . 
            ::= stm {stack-pop} ; stms 
stm         ::= expr 
expr        ::= NUMBER {stack-pushnumber[$]} 
            ::= funcall 
            ::= varuse 
            ::= lambda 
funcall     ::= NAME {symboltbl-check[$]} {begin-call} argList {call-named[$]} {end-call} 
            ::= ( expr ) {begin-call} argList {call-stack} {end-call} 
argList     ::= ( ) 
            ::= ( args ) 
args        ::= expr , args 
            ::= expr {call-push[stack]} 
varuse      ::= NAME {symboltbl-check[$]} {stack-pushnamed[symboltbl]} 
lambda      ::= captureList paramList {begin-symboltbl[lambda]} -> type {lambda-type[$]} {begin-jmp} stms {jmp-here} {end-jmp} 
captureList ::= [ {begin-lambda} ] 
            ::= [ {begin-lambda} captures ] 
captures    ::= NAME {lambda-add-capture[$]} , captures 
            ::= NAME {lambda-add-capture[$]} 
paramlist   ::= ( ) 
            ::= ( params ) 
paramList   ::= param , params 
            ::= param 
param       ::= NAME {lambda-add-param[$]} : type {lambda-param-type[type]} {end-type} 
type        ::= NUMBER {begin-type[$]} 
            ::= aparamList -> type {signature-type[type]} {end-type} {begin-type[signature]} {end-signature} 
aparamList  ::= ( {begin-signature} ) 
            ::= ( {begin-signature} aparamList ) 
aparams     ::= type {signature-add[type]} {end-type} , aparams 
            ::= type {signature-add[type]} {end-type} 
NAME        ::= /([\w_][\w_\d]*)/
NUMBER      ::= /([\d][_\d]*)/
</script>
<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="https://raw.githubusercontent.com/jonnyreeves/jquery-Mustache/master/jquery.mustache.js"></script>
<script src="https://raw.github.com/janl/mustache.js/master/mustache.js"></script>
<script>
$(function(){
    'use strict'
    $.Mustache.addFromDom('templ-output');
    $.Mustache.addFromDom('templ-edit');
    $.Mustache.addFromDom('templ-tokens');
    var foundTokens = {};

    function makeRuleDefinition(ruleDef){
        return ruleDef.split(' ').map(function(ruleItem){
            return ruleItem.trim();
        }).filter(function(ruleItem){
            return ruleItem.length;
        }).map(function(ruleItem){
            if(ruleItem[0] !== ruleItem[0].toUpperCase()){
                return {
                    link: '#rule-'+ruleItem,
                    classes: 'production',
                    item: ruleItem,
                };
            } 
            if(ruleItem[0]=== '{' 
               && ruleItem[ruleItem.length-1]==='}'){
                return {
                    link: '#func-'+ruleItem,
                    classes: 'semantic',
                    item: ruleItem,
                };
            }
            if(ruleItem[0]=== '/' && ruleItem[ruleItem.length-1]==='/'){
                return {
                    classes: 'regex',
                    item: ruleItem,
                };
            }
            foundTokens[ruleItem] = (foundTokens[ruleItem]||0)+1;
            return {
                link: '#rule-'+ruleItem,
                classes: 'terminal',
                item: ruleItem,
            };
        });
    }

    function disassembleRuleDefinition($this){
        if($this.is('.terminal')){
            --foundTokens[$this.text().trim()];
        }
        return $this.text().trim() + ' ';
    }

    $('.jAdd').click(function(){
        var even = true;
        var bruteText = $('#input').val()||$('#default-syntax').text();
        var lines = bruteText.split('\n');
        var oldRuleName = '';
        var rules = lines.filter(function(cline){
            if(!cline || cline[0]==='#'){
                return false;
            }
            var pos = cline.indexOf('::=');
            if(pos === -1 || cline.indexOf('::=', pos+1) !== -1){
                return false;
            }
            return true;
        }).map(function(cline){
            var line = cline.split('::=');
            var ruleName = line[0].trim();
            var ruleDef = makeRuleDefinition(line[1].trim());
            var newRule = ruleName && ruleName !== oldRuleName;
            if(newRule){
                even = !even;
                oldRuleName = ruleName;
            }else {
                ruleName = oldRuleName;
            }
            return {
                ruleName:ruleName,
                even: even,
                newRule: newRule,
                ruleDef: ruleDef,
            };
        });
        $('.buttons').show();
        $('#output').mustache('templ-output', {rules:rules});
        resizeTextArea($('#input').val(''));
        refreshExtraTokens();
    });
    $('.jEditAll').click(function(){
        var spaces = 0;
        $('#output .rule .name').each(function(){
            var length =$(this).text().trim().length;
            if(length >= spaces){
                spaces = length + 1;
            }
        });
        var input = '';
        var oldName = '';
        $('#output .rule').each(function(){
            var $rule = $(this);
            var name = $rule.find('.name').text().trim();
            if(name != oldName){
                oldName = name;
                input += name;
            }else {
                name = '';
            }
            var sz = spaces - name.length;
            for(var i = 0; i < sz; ++i) {
                input += ' ';
            }
            input += '::= ';
            $rule.find('.def-item').each(function(){
                input += disassembleRuleDefinition($(this));
            });
            input += '\n';
            $('.buttons').hide();
        });    
        $('#input').val(input.slice(0, -1));
        $('#output').empty();
        resizeTextArea($('#input'));
    });
    $('.jToogle').click(function(){
        $('.semantic').toggle();
    });
    function getRuleClass($button){
        return '.' + $button.closest('.rule').attr('id');
    }
    $('#output').on('click', '.jDelete', function(){
        var $this = $(this);
        $this.closest('.rule').nextAll().toggleClass('even');
        $(getRuleClass($this)).remove();
    });
    $('#output').on('click', '.jUp', function(){
        var $currentHead = $(this).closest('.rule');
        var $current = $(getRuleClass($currentHead));
        var $prevHead = $currentHead.prevAll('.head').first();
        var $prev = $(getRuleClass($prevHead));
        $prev.toggleClass('even');
        $current.toggleClass('even');
        $current.each(function(){
            $prevHead.before($(this));
        });
    });

    $('#output').on('click', '.jDown', function(){
        var $currentHead = $(this).closest('.rule');
        var $current = $(getRuleClass($currentHead));
        var $nextHead = $currentHead.nextAll('.head').first();
        var $next = $(getRuleClass($nextHead));
        $next.toggleClass('even');
        $current.toggleClass('even');
        $next.each(function(){
            $currentHead.before($(this));
        });
    });

    $('#output').on('click', '.jEdit', function(){
        var className = getRuleClass($(this));
        var $current = $(className);
        var newVal = '';
        var lineCount = 0;
        $current.each(function(){
            $(this).find('.def-item').each(function(){
                newVal += disassembleRuleDefinition($(this));
            });
            newVal += '\n';
            lineCount ++;
        });

        
        var $currentHead = $current.first();
        $currentHead.find(':not(.name)').remove();
        $currentHead.mustache('templ-edit', {
            value:newVal.slice(0, -1)
        });
        $currentHead.data('even', $current.hasClass('even'));
        $current.not($currentHead).remove();

        resizeTextArea($currentHead.find('textarea'));
    });

    $('#output').on('click', '.jResetEdit', function(){
        var $value = $(this).closest('.rule').find('.value');
        $value.val($value.text());
    });
    $('#output').on('click', '.jOkEdit', function(){
        var $editRule = $(this).closest('.rule');
        var $value = $editRule.find('.value');
        var newVal = $value.val();
        var name = $editRule.find('.name').text().trim();
        $editRule.before($.Mustache.render('templ-output', {
            rules: newVal.split('\n').map(function(v){
                return v.trim();
            }).filter(function(cline){
                if(!cline.trim() || cline[0]==='#'){
                    return false;
                }
                return true;
            }).map(function(ruleDef, i){
                return {
                    ruleName: name,
                    even: $editRule.data('even'),
                    newRule: i==0,
                    ruleDef: makeRuleDefinition(ruleDef),
                };
            })
        }));
        $editRule.remove();
        refreshExtraTokens();
    });
    function resizeTextArea($textarea){
        var lines = $textarea.val().split('\n');
        var nrows = lines.length;
        var ncols = lines.reduce(function(prev, curr){
            return Math.max(prev, curr.length);
        }, 0);
        $textarea.attr('rows', Math.max(1, nrows-1));
        $textarea.attr('cols', Math.max(ncols, 40));
    }
    $('body').on('input', 'textarea', function(){
        var $this = $(this);
        resizeTextArea($this);
    });

    function refreshExtraTokens(){
        var $extraTokens = $('.extra-tokens').empty();
        for(var token in foundTokens){
            if(document.getElementById('rule-'+token)){
                continue;
            }
            $extraTokens.append('<span id="rule-'+token+'">'+token+'</span>');
        }
    }
    $('.export-json').click(function(event) {
        'use strict'
        //event.preventDefault();
        /* Act on the event */
        var productions = {};
        var terminals = {};
        var $output = $('#output');
        var start = $output.find('.rule.head:first .name').text().trim();
        var initialization = [];
        $output.find('.rule.head').each(function(index, el) {
            var $this = $(this);
            var name = $this.find('.name').text().trim();
            var initial = name[0];
            if(initial == initial.toUpperCase()){
                terminals[name] = $this.find('.definition').text().trim();
            } else {
                var variants = [];
                $output.find('.rule-'+name).each(function() {
                    var items = [];
                    $(this).find('.def-item').each(function() {
                        var $item = $(this);
                        if($item.hasClass('semantic')){
                            var text = $item.text().trim();
                            var matches = text.match(/\{(?:(begin|end)\-)?([\w\d_]+)?(?:-([\w\d_-]+))?(\[(\$|[\w\d_]+)\])?\}/);
                            if(!matches){
                                throw new Error('Wrong Format:'+text);
                            }
                            var call = {
                                type:   matches[1]||'call',
                                object: matches[2],
                                action: matches[3]||null,
                                param:  matches[4]?(matches[5]=='$'?true:matches[5]):(false)
                            };
                            if(items.length){
                                var last = items[items.length-1]; 
                                last.actions.push(call);
                            } else if(name === start){
                                initialization.push(call);
                            } else {
                                throw new Error('invalid semantic location');
                            }
                        }else {
                            items.push({
                                item: $item.text().trim(),
                                actions: []
                            }); 
                        }
                    });
                    variants.push(items);
                });
                productions[name] = variants;
            }
        });
        var result = {
            productions: productions,
            terminals: terminals,
            start: start,
            initialization: initialization
        };
        this.href = 'data:,'+JSON.stringify(result);
        //return false;
    });

    //Dirt trick
    $('.jAdd').click();
})
</script>
</head>
<body>
<section id="sintax">
    <h1>Syntax</h1>
    <div class="buttons">
        <button class="jToogle">Change View</button>
        <button class="jEditAll">Edit All</button>
    </div>
    <div id="output"></div>
    <textarea id="input" placeholder="New Rules Here"></textarea>
    <button class="jAdd">Add</button>
    <h2>Extra Tokens</h2>
    <div class="extra-tokens">
    </div>
    <h2>Export</h2>
    <div class="buttons">
        <a class="export-json" download="export.json" href>Export JSON</a>
    </div>
</section>
<section id="semantic">
    <h1>Semantics</h1>
</section>
</body>
</html>